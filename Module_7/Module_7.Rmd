# Analyse de variance à deux critères

Dans la leçon précédente, nous avons vu l'application de l'analyse de la variance (ANOVA) dans des expériences où il n'y avait qu'un seul critère de classification (ou facteur). Les observations étaient classées selon un seul facteur en un nombre donné de groupes. Nous pouvions ainsi tester l'influence de ce facteur (p. ex., le sexe) sur la variable réponse. Dans d'autres cas, les données peuvent être réparties selon deux facteurs ou critères de classification. Par exemple, nous pourrions avoir une expérience qui étudie la concentration de calcium dans le plasma sanguin (la variable réponse) selon le traitement hormonal (avec traitement *vs* sans traitement) pour des individus selon leur sexe (mâle *vs* femelle). Nous pouvons généraliser l'ANOVA en présence de plusieurs facteurs. En présence de deux facteurs, nous réaliserons l'ANOVA à deux critères de classification (c.-à-d., facteurs). 

## Théories

### ANOVA à deux critères

On pourrait avoir le réflexe d'effectuer deux analyses, en effectuant une ANOVA à un critère sur chacun des facteurs pris séparément. Toutefois, cette approche n'est pas optimale, puisqu'effectuer deux tests séparément augmentera notre probabilité de commettre une erreur de type I (c.-à-d., un faux positif). En plus de tester l'effet de chacun des facteurs sur la variable réponse, l'ANOVA à deux critères permet de tester si l'effet d'un facteur dépend du niveau de l'autre. C'est ce qu'on entend par l'**interaction** entre les deux facteurs sur la variable réponse. Ainsi, nous dirons qu'il y a interaction entre le traitement hormonal et le sexe lorsque l'effet du traitement sur la concentration en calcium est soit plus grand ou plus petit selon le sexe des individus étudiés, et vice-versa, c'est-à-dire que la différence de la variable réponse entre mâle et femelle dépend du traitement hormonal. L'interaction est souvent d'intérêt puisqu'elle révèle un patron inattendu. 

À noter qu'on peut tester le terme d'interaction uniquement lorsqu'on a plus d'une observation pour chaque combinaison des groupes des deux facteurs (p. ex., mâle avec traitement, mâle sans traitement, femelle avec traitement, femelle sans traitement). On dit alors qu'il y a des **répétitions** (*replication*). Nous illustrerons le concept de l'interaction dans les exemples de cette leçon. L'ANOVA à un critère effectuée séparément sur chaque traitement ne permet pas de tester d'interaction, et c'est pourquoi il est préférable d'utiliser l'ANOVA à deux critères pour analyser les données en une seule étape.

### Suppositions et dispositif expérimental 

L'ANOVA à deux critères requiert les mêmes suppositions que l'ANOVA à un critère, soit l'indépendance des observations, l'homoscédasticité et la normalité des résidus. Toutefois, le design expérimental de l'ANOVA à deux critères diffère légèrement de celui de l'ANOVA à un critère. À titre de rappel, l'ANOVA à un critère utilise un dispositif expérimental complètement aléatoire. On attribue aléatoirement un traitement (c.-à-d., un des niveaux du facteur testé) à chacune des unités expérimentales. Ici, l'unité expérimentale dépend de l'expérience, mais peut être constituée d'un patient, d'un client sondé au téléphone, d'un quadrat, d'un aquarium, ou d'un site, par exemple. Dans une expérience avec deux facteurs, nous attribuerons aléatoirement une combinaison des deux facteurs à chaque unité expérimentale. 

Reprenons notre exemple sur le traitement hormonal en fonction du sexe. Quatre combinaisons de groupes des deux facteurs sont possibles: mâle sans traitement, mâle avec traitement hormonal, femelle sans traitement et femelle avec traitement hormonal. Un **dispositif équilibré** (*balanced design*), c'est-à-dire, une expérience avec un nombre égal d'observations pour chaque combinaison des traitements, procure une puissance plus élevée qu'un dispositif avec un nombre inégal d'observations par combinaison des traitements. Ainsi, on devrait sélectionner un nombre égal de mâles et de femelles et attribuer le traitement à la moitié des mâles et des femelles.

### Hypothèses statistiques

Les hypothèses statistiques de l'ANOVA à deux critères sont formulées de la même façon qu'avec l'ANOVA à un critère. Poursuivons l'exemple en testant les différences entre les moyennes des groupes définis par le facteur d'intérêt :  

  Traitement hormonal :  
$H_0$: $\mu_{\mathrm{horm}} = \mu_{\mathrm{sans.horm}}$ (non-différence)  
$H_a$: $\mu_{\mathrm{horm}} \neq \mu_{\mathrm{sans.horm}}$  

  Sexe :  
$H_0$: $\mu_{\mathrm{m\hat{a}le}} = \mu_{\mathrm{femelle}}$ (non-différence)  
$H_a$: $\mu_{\mathrm{m\hat{a}le}} \neq \mu_{\mathrm{femelle}}$  

Puisqu'il y a plusieurs observations par combinaison des deux facteurs (mâle avec traitement, mâle sans traitement, femelle avec traitement, femelle sans traitement), il est possible de tester l'interaction entre le traitement hormonal et le sexe. Le terme d'interaction teste si l'effet du traitement hormonal sur la variable réponse dépend du sexe.  

  Interaction traitement hormonal $\times$ sexe :  
$H_0$: $\mu_{\mathrm{m\hat{a}le -- horm}} = \mu_{\mathrm{m\hat{a}le -- sans.horm}} = \mu_{\mathrm{femelle -- horm}} = \mu_{\mathrm{femelle -- sans.horm}}$ (non-différence)  
$H_a$: au moins une moyenne diffère des autres  

En mots, si la différence de moyenne entre traitement et sans traitement est égale entre mâle et femelle, il n'y a pas d'interactions et on ne rejette pas $H_0$. À noter que cette dernière hypothèse ne peut pas être testée en présence d'une seule observation pour chaque combinaison des deux facteurs -- il faut plus d'une observation (répétition) pour tester le terme d'interaction. Le seuil de signification ($\alpha$) pour chacune de ces hypothèses est de 0.05.

### Sommes des carrés

On construit les sommes des carrés de l'ANOVA à deux critères de classification de façon similaire à l'ANOVA à un critère de classification. Ainsi, la somme des carrés totale ($SST$) s'obtient avec :  

$$SST = \sum_{i=1}^a \sum_{j=1}^b \sum_{k=1}^n (y_{ijk} - \bar{y})^2$$   

où on compare l'observation $k$ du groupe $i$ du facteur $A$ et du groupe $j$ du facteur $B$ ($y_{ijk}$) à la moyenne globale ($\bar{y}$). Les degrés de liberté associés à la somme des carrés totale est obtenue à l'aide de $df = N - 1$, où $N$ correspond au nombre total d'observations dans l'expérience.  

On calcule la somme des carrés de chaque facteur de la même manière que pour une ANOVA à un critère. Nous obtenons ainsi :  

$$ SSA = \sum_{i=1}^a \sum_{k=1}^n (\bar{y}_{i} - \bar{y})^2 = n \sum_{i=1}^a (\bar{y}_{i} - \bar{y})^2$$
où on compare la moyenne de chaque groupe $i$ du facteur $A$ ($\bar{y}_{i}$) à la moyenne globale ($\bar{y}$) et où ce calcul se répète $n$ fois pour chaque moyenne d'un groupe $i$ donné. Les degrés de liberté correspondant à $SSA$ sont donnés par $df = a - 1$, où $a$ est le nombre de groupes défini par le facteur A. Le calcul de la somme des carrés du deuxième facteur ($B$) est identique à celui du facteur $A$ :  

$$SSB = \sum_{j=1}^b \sum_{k=1}^n (\bar{y}_{j} - \bar{y})^2 = n \sum_{j=1}^b (\bar{y}_{j} - \bar{y})^2$$

Les degrés de liberté s'obtiennent avec $df = b - 1$, où $b$ correspond au nombre de groupes du facteur $B$. 

La somme des carrés résiduelle ($SSE$), aussi appelée somme des carrés des erreurs, se calcule de la même façon que pour l'ANOVA à un critère:

$$SSE = \sum_{i=1}^a \sum_{j=1}^b \sum_{k=1}^n (y_{ijk} - \bar{y}_{ij})^2$$

où on compare une observation $k$ appartenant à la fois à un groupe donné $i$ du facteur $A$ et d'un groupe $j$ du facteur $B$ à la moyenne de ces groupes combinés ($\bar{y}_{ij}$). Les degrés de liberté associés à $SSE$ sont $df = ab(n - 1)$, où $a$ et $b$ sont le nombre de groupes du facteur $A$ et $B$, respectivement, et $n$ est le nombre d'observations pour chaque combinaison des facteurs $A$ et $B$.   

L'ANOVA à deux critères qui contient plus d'une observation des combinaisons de groupes des deux facteurs permet de tester l'interaction entre les deux facteurs de l'expérience. La somme des carrés de l'interaction ($SSInter$) s'obtient avec:

$$SSinter = \sum_{i=1}^a \sum_{j=1}^b \sum_{k=1}^n ( (\bar{y}_{ij} -\bar{y}) - (\bar{y}_i - \bar{y} )  - (\bar{y}_j - \bar{y}) )^2$$  

où le premier terme, $(\bar{y}_{ij} -\bar{y})$, est la différence observée de la moyenne des groupes combinés $i$ et $j$  avec la moyenne globale, et les deux autres termes représentent la différence que devrait avoir cette moyenne des groupes combinés avec la moyenne globale s'il n'y avait pas d'interaction, c-à-d, la somme des différences entre la moyenne du groupe $i$ et la moyenne globale, $(\bar{y}_{i} -\bar{y})$, et entre la moyenne du groupe $j$ et la moyenne globale, $(\bar{y}_{j} -\bar{y})$. Nous pouvons simplifier l'équation pour $SSinter$:

$$ SSinter = \sum_{i=1}^a \sum_{j=1}^b \sum_{k=1}^n (\bar{y}_{ij} - \bar{y}_i - \bar{y}_j + \bar{y})^2 = n \sum_{i=1}^a \sum_{j=1}^b  (\bar{y}_{ij} - \bar{y}_i - \bar{y}_j + \bar{y})^2$$

L'exemple qui suit illustre le calcul de ces différentes valeurs nécessaires à l'ANOVA à deux critères. Les degrés de liberté associés au terme $SSInter$ sont donnés par $df = (a - 1)(b - 1)$, où $a$ et $b$ correspondent aux nombre de groupes du facteur $A$ et $B$, respectivement.



:::{.exemple section=7}
On s'intéresse à l'effet d'un traitement hormonal sur la concentration de calcium dans le plasma sanguin chez des oiseaux mâles et femelles. La variable réponse est la concentration du calcium dans le plasma sanguin. Nos deux facteurs sont le traitement hormonal (avec traitement, sans traitement) et le sexe (mâle, femelle). Les données sont contenues dans le fichier `calcium.txt`.

```{r echo = TRUE, keep.source = TRUE}
## On importe le jeu de données
calcium <- read.table("Module_7/data/calcium.txt", header = TRUE)

## On jette un coup d'oeil aux premières observations
head(calcium)

## On transforme en facteurs les colonnes 
## de caractères `Trait` et `Sexe`
calcium$Trait <- as.factor(calcium$Trait)
calcium$Sexe <- as.factor(calcium$Sexe)
```

La Figure \@ref(fig:boxplotcalcium illustre les données selon les différentes combinaisons des deux facteurs.

```{r boxplotcalcium, echo = TRUE, keep.source = TRUE, fig = TRUE, fig.align='center', fig.cap="Diagramme de boîtes et moustaches avec les données de concentration en calcium en fonction du traitement hormonal et du sexe."}
## On crée un boxplot pour chaque
## combinaison des deux facteurs
boxplot(Concentration ~ Trait + Sexe, data = calcium,
        ylab = "Concentration", 
        xlab = "Combinaison de traitement et sexe",
        cex.lab = 1.2)
``` 

On peut déterminer le nombre d'observations pour chaque combinaison des deux facteurs à l'aide de la fonction `table( )` :

```{r echo = TRUE, keep.source = TRUE}
## On détermine le nombre de répétitions par groupe
table(calcium$Trait, calcium$Sexe)
``` 

On constate qu'il y a cinq observations pour chaque combinaison des niveaux des deux facteurs. Nous dirons donc qu'il y a cinq répétitions (*replicates*) par combinaison de traitements.

Calculons la somme des carrés totale :

```{r SST, echo = TRUE, keep.source = TRUE}
##moyenne globale
y.bar <- mean(calcium$Concentration)
##SST
SST <- sum((calcium$Concentration - y.bar)^2)
SST
##df
df.SST <- length(calcium$Concentration) - 1
``` 

On peut ensuite calculer la somme des carrés des facteurs $A$ et $B$ :

```{r SSA, echo = TRUE, keep.source = TRUE}
##sous-jeu de données
fem <- calcium[calcium$Sexe == "f", ]
mal <- calcium[calcium$Sexe == "m", ]
horm <- calcium[calcium$Trait == "horm", ]
nohorm <- calcium[calcium$Trait == "sans_horm", ]

##moyenne des groupes
y.bar.f <- mean(fem$Concentration)
y.bar.m <- mean(mal$Concentration)
y.bar.horm <- mean(horm$Concentration)
y.bar.nohorm <- mean(nohorm$Concentration)
## Calcul de SSA
## où le nombre d'observations femelle et mâle est
nrow(fem)
nrow(mal)

SSA <- 10*(y.bar.f - y.bar)^2 + 10*(y.bar.m - y.bar)^2
SSA
## Calculer df.SSA. On a df.SSA<- a - 1 
## où a est le nombre de groupes definis par le facteur A.
## Ici, il y a homme et femme, donc a = 2.
df.SSA <- 2 - 1
df.SSA
##SSB
## où le nombre d'observations horm et nohorm est
nrow(horm)
nrow(nohorm)

SSB <- 10*(y.bar.horm - y.bar)^2 + 10*(y.bar.nohorm - y.bar)^2
SSB

## Calculer df.SSB. On a df.SSB<- b - 1 
## où b est le nombre de groupes définis par le facteur B. 
## Ici, il y a traitement hormonal et pas
## de traitement, donc b = 2
df.SSB <-  2 - 1
df.SSB
```

La somme des carrés des erreurs se calcule comme suit :

```{r SSE, echo = TRUE, keep.source = TRUE}
##sous-groupes en combinant les deux facteurs
f.horm <- calcium[calcium$Sexe == "f" & calcium$Trait == "horm", ]
m.horm <- calcium[calcium$Sexe == "m" & calcium$Trait == "horm", ] 
f.nohorm <- calcium[calcium$Sexe == "f" & calcium$Trait == "sans_horm", ]
m.nohorm <- calcium[calcium$Sexe == "m" & calcium$Trait == "sans_horm", ]
##
##calculs des moyennes des combinaisons de groupes
y.bar.f.horm <- mean(f.horm$Concentration)
y.bar.m.horm <- mean(m.horm$Concentration)
y.bar.f.nohorm <- mean(f.nohorm$Concentration)
y.bar.m.nohorm <- mean(m.nohorm$Concentration)
##
## Calcul de SSE
SSE.f.horm <- sum((f.horm$Concentration - y.bar.f.horm)^2)
SSE.m.horm <- sum((m.horm$Concentration - y.bar.m.horm)^2)
SSE.f.nohorm <- sum((f.nohorm$Concentration - y.bar.f.nohorm)^2)
SSE.m.nohorm <- sum((m.nohorm$Concentration - y.bar.m.nohorm)^2)
SSE <- SSE.f.horm + SSE.m.horm + SSE.f.nohorm + SSE.m.nohorm
SSE
##
## Cacul des degrés de liberté
## df.SSE = ab(n-1), où a et b sont le nombre de groupes 
## du facteur A et B, respectivement,
## et n est le nombre d'observations pour chaque combinaison 
## des facteurs A et B.
df.SSE <- length(levels(calcium$Sexe)) * 
          length(levels(calcium$Trait)) * (5 - 1)
df.SSE
``` 

Finalement, on obtient la somme des carrés du terme d'interaction entre les deux facteurs. Notez que l'équation pour $SSinter$ peut se décomposer de la façon suivante:

$$SSinter = n \sum_{i=1}^a \sum_{j=1}^b  (\bar{y}_{ij} - \bar{y}_i - \bar{y}_j + \bar{y})^2  $$
$$= n \sum_{i=1}^a ( (\bar{y}_{i.horm} - \bar{y}_i - \bar{y}_{horm} + \bar{y})^2 + (\bar{y}_{i.nohorm} - \bar{y}_i - \bar{y}_{nohorm} + \bar{y})^2)$$  
$$= n ( (\bar{y}_{f.horm} - \bar{y}_f - \bar{y}_{horm} + \bar{y})^2$$   
$$+ (\bar{y}_{f.nohorm} - \bar{y}_f - \bar{y}_{nohorm} + \bar{y})^2 $$  
$$+ (\bar{y}_{m.horm} - \bar{y}_m - \bar{y}_{horm} + \bar{y})^2  $$ 
$$+ (\bar{y}_{m.nohorm} - \bar{y}_m - \bar{y}_{nohorm} + \bar{y})^2)) $$
Ansi, nous calculons $SSinter$ de la façon suivante :

```{r SSInter, echo = TRUE, keep.source = TRUE}
## SS de l'interaction
SSInter.f.horm <- 5*sum((y.bar.f.horm - y.bar.f - y.bar.horm + y.bar)^2)
SSInter.m.horm <- 5*sum((y.bar.m.horm - y.bar.m - y.bar.horm + y.bar)^2)
SSInter.f.nohorm <- 5*sum((y.bar.f.nohorm - y.bar.f - 
                             y.bar.nohorm + y.bar)^2)
SSInter.m.nohorm <- 5*sum((y.bar.m.nohorm - y.bar.m - 
                             y.bar.nohorm + y.bar)^2)
SSInter <- SSInter.f.horm + SSInter.m.horm + 
           SSInter.f.nohorm + SSInter.m.nohorm

SSInter
## degrés de liberté de SSInter
## df.SSInter = (a-1)(b-1), où a et b correspondent aux  
## nombre de groupes du facteur A et B, respectivement.

df.SSInter <- df.SSA * df.SSB
df.SSInter
``` 

On peut réaliser tous ces calculs directement dans R à l'aide de la fonction `aov( )` :

```{r echo = TRUE, keep.source = TRUE}
aov2 <- aov(Concentration ~ Sexe + Trait + Sexe:Trait, data = calcium)
summary(aov2)
``` 

On peut reconstituer ce même tableau à partir des calculs que nous avons effectués plus haut :

```{r table, echo = TRUE, keep.source = TRUE}
result <- data.frame(Df = c(df.SSA, df.SSB, df.SSInter, df.SSE),
                     Sum.Sq = c(SSA, SSB, SSInter, SSE))
result$Mean.Sq <- result$Sum.Sq/result$Df
result$F.value <- c(result$Mean.Sq[1]/result$Mean.Sq[4],
                    result$Mean.Sq[2]/result$Mean.Sq[4],
                    result$Mean.Sq[3]/result$Mean.Sq[4],
                    NA)
result$P.value <- c(1 - pf(result$F.value[1], 
                    df1 = result$Df[1], 
                    df2 = result$Df[4]),
                    1 - pf(result$F.value[2], 
                    df1 = result$Df[2], 
                    df2 = result$Df[4]),
                    1 - pf(result$F.value[3], 
                    df1 = result$Df[3],  
                    df2 = result$Df[4]), 
                    NA)  

##tableau identique à aov( )
result
``` 

Avant d'interpréter les résultats, on doit vérifier les suppositions du modèle. On vérifie les suppositions de l'ANOVA à deux critères avec les mêmes outils que pour l'ANOVA à un critère. On constate que les résidus suivent une distribution normale (Figure \@ref(fig:normcalcium)a):

```{r normcalcium, echo = TRUE, keep.source = TRUE, include = TRUE, fig.align='center', fig.cap="Graphique quantile-quantile évaluant la normalité des résidus (a) et le graphique des résidus en fonction des valeurs prédites pour diagnostiquer l'hétérogénéité de la variance (b) à partir de l'ANOVA à deux critères sur les données de concentration en calcium dans le plasma sanguin."}
##vérification de la normalité des résidus
par(mfrow = c(1, 2))

qqnorm(residuals(aov2),
       main = "Normalité des résidus",
       ylab = "Quantiles observés", 
       xlab = "Quantiles théoriques", 
       cex.lab = 1.2)

qqline(residuals(aov2))

text(x = -1.9, y = 7.5, labels = "a", cex = 1.2)

plot(residuals(aov2) ~ fitted(aov2), 
     xlab = "Valeurs prédites",
     ylab = "Résidus", 
     cex.lab = 1.2)

text(x = 12.5, y = 7.5, labels = "b", cex = 1.2)
``` 

Le graphique des résidus en fonction des valeurs prédites présente des signes d'hétérogénéité de la variance (Figure \@ref(fig:normcalcium)b). En effet, le patron en forme d'entonnoir montre que la variance augmente avec les valeurs prédites. Par conséquent, on ne peut pas interpréter le tableau de l'ANOVA obtenu plus haut. Afin de corriger l'hétérogénéité de la variance, la transformation logarithmique s'avère souvent efficace. Essayons-la sur la concentration en calcium.

```{r log, echo = TRUE, keep.source = TRUE}
## Transformation log
calcium$log.concentration <- log(calcium$Concentration)
aov.log <- aov(log.concentration ~ Trait + Sexe + Trait:Sexe,
               data = calcium)
``` 

Produisons le nouveau graphique pour évaluer la normalité des résidus et l'hétérogénéité de la variace.

```{r logcheck, echo = TRUE, keep.source = TRUE, fig.align='center', fig.cap="Graphique quantile-quantile (a) et résidus en fonction des valeurs prédites (b) de l'ANOVA à deux critères réalisée à partir des données de concentration de calcium log-transformées."}
par(mfrow = c(1, 2))

qqnorm(residuals(aov.log), 
       ylab = "Quantiles observés",
       xlab = "Quantiles prédits",
       main = " ", cex.lab = 1.2)

qqline(residuals(aov.log))

text(x = 1.5, y = -0.35, labels = "a", cex = 1.2)

plot(residuals(aov.log) ~ fitted(aov.log),
     ylab = "Résidus", 
     xlab = "Valeurs prédites",
     cex.lab = 1.2)

text(x = 3.3, y = -0.35, labels = "b", cex = 1.2)
``` 

Les suppositions de normalité et d'homogénéité de la variance sont maintenant respectées (Figure \@ref(fig:logcheck)).  

Le tableau d'ANOVA réalisé à partir du logarithme de la concentration en calcium donne :

```{r reslog, echo = TRUE, keep.source = TRUE}
## Résultats
summary(aov.log)
``` 

Lorsqu'on effectue une analyse de variance à deux critères avec répétitions, on doit toujours vérifier en premier la signification du terme d'interaction. Ici, on remarque qu'il n'y a pas d'interaction entre les deux facteurs (\mbox{$F_{1, 16} = 0.18, P = 0.681$}). Par ailleurs, on remarque un effet marginal du sexe (\mbox{$F_{1, 16} = 3.90, P = 0.066$})^[Les résultats de l'ANOVA montrent que la probabilité associée au facteur sexe est suffisamment près du seuil de 0.05 pour que l'effet soit considéré biologiquement significatif. Pour cette raison, on peut retenir ce facteur dans les comparaisons multiples.] et un effet important du traitement hormonal sur le log de la concentration en calcium ($F_{1, 16} = 86.12, P < 0.0001$). L'effet de chaque facteur est indépendant de l'effet de l'autre, puisque l'ANOVA n'a pu démontrer que le terme d'interaction était statistiquement significatif.  

Tout comme l'ANOVA à un critère, on peut poursuivre l'ANOVA à deux critères avec des comparaisons multiples afin de déterminer où se trouvent les différences lorsque nous avons rejeté $H_0$^[À noter que dans notre exemple, il n'y a que deux niveaux (groupes) à chaque facteur: sexe a deux niveaux (mâle, femelle), et traitement hormonal n'a que deux niveaux (avec traitement, sans traitement). Ainsi, il ne serait pas absolument nécessaire de poursuivre avec des comparaisons multiples, car si on rejette $H_0$, on sait que les deux groupes diffèrent entre eux.].  

```{r echo = TRUE, keep.source = TRUE}
##comparaisons multiples - Sexe
sexe.mult <- TukeyHSD(aov.log, which = "Sexe")
sexe.mult$Sexe

##comparaisons multiples - Trait
trait.mult <- TukeyHSD(aov.log, which = "Trait")
trait.mult$Trait
``` 

Les comparaisons multiples basées sur le test de Tukey indiquent la même conclusion que le tableau d'ANOVA, puisque chaque facteur ne comporte ici que deux niveaux. Le log de la concentration en calcium du plasma sanguin des femelles est marginalement supérieur à celui des mâles ($\bar{x}_{\mathrm{m\hat{a}les}} - \bar{x}_{\mathrm{femelles}} = `r round(sexe.mult$Sexe[1,1], digits = 3)`, P = `r round(sexe.mult$Sexe[1,4], digits = 4)`$). En ce qui concerne le facteur du traitement hormonal, on constate que le groupe avec traitement hormonal est supérieur à celui du groupe sans traitement hormonal ($\bar{x}_{\mathrm{sans\_horm}} - \bar{x}_{\mathrm{horm}} = `r round(trait.mult$Trait[1,1], digits = 3)`, P < 0.0001$). 

On peut aussi illustrer les résultats à l'aide d'un graphique en représentant les moyennes de chaque groupe $\pm$ un intervalle de confiance à 95 \%. Tout d'abord produisons un graphique sur une échelle logarithmique.  

```{r plotresultlog, echo = TRUE, keep.source = TRUE, eval = FALSE, fig = FALSE}
## Sexe - moyenne des groupes
## valeurs pour lesquelles faire des prédictions
## On commence par créer un tableau dans lequel 
## chaque ligne correspond à une combinaison des facteurs A et B.
pred.set <- expand.grid(Sexe = c("m", "f"), 
                        Trait = c("sans_horm", "horm"))

## La fonction predict nous donne les valeurs prédites par l’ANOVA
sex.means <- predict(aov.log, newdata = pred.set, se.fit = TRUE)

## Ajout des prédictions dans le jeu de données
pred.set$fit <- sex.means$fit
pred.set$se.fit <- sex.means$se.fit

##IC à 95%
## On détermine l’intervalle de confiance pour 
## construire nos barres d’erreur
## Rappelons que l’intervalle de confiance est donné par : 
## (IC.inf, IC.sup) (voir leçon 2)
## IC.inf = x.bar + qt(p=0.025, df)*SE
## IC.sup = x.bar - qt(p=0.025, df)*SE

pred.set$low95 <- pred.set$fit + 
  qt(p = 0.025, df = aov.log$df.residual) * pred.set$se.fit

pred.set$upp95 <- pred.set$fit - 
  qt(p = 0.025, df = aov.log$df.residual) * pred.set$se.fit
pred.set

##créer le graphique
plot(y = 0, x = 0, 
     ylab = "Log de la concentration en calcium",
     xlab = "Traitement", 
     ylim = c(min(pred.set$low95), max(pred.set$upp95)), 
     cex.lab = 2,
     xlim = c(0, 3), 
     type = "n", 
     cex.axis = 2, 
     xaxt = "n", 
     main = "Moyennes ± IC 95 % (échelle log)", 
     cex.main = 2)

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2), 
     labels = c("sans horm", "horm"), 
     cex.axis = 2)

##ajout des points pour mâles
points(y = pred.set$fit[c(1,3)], 
       x = c(0.9, 1.9), 
       pch = 1, 
       cex = 2)

##ajout des points pour femelles
points(y = pred.set$fit[c(2,4)], 
       x = c(1.1, 2.1), 
       pch = 2, 
       cex = 2)

##barres d'erreurs pour mâles
arrows(x0 = c(0.9, 1.9), 
       y0 = pred.set$low95[c(1, 3)], 
       y1 = pred.set$upp95[c(1, 3)],
       x1 = c(0.9, 1.9), 
       angle = 90, 
       code = 3, 
       length = 0.05)

##barres d'erreurs pour femelles
arrows(x0 = c(1.1, 2.1), 
       y0 = pred.set$low95[c(2, 4)], 
       y1 = pred.set$upp95[c(2, 4)],
       x1 = c(1.1, 2.1), 
       angle = 90, 
       code = 3, 
       length = 0.05)

##ajouter légende
legend(x = "topleft", 
       legend = c("mâles", "femelles"), 
       pch = c(1, 2))

text(x = 2.8, y = 2.3, labels = "a", cex = 2)
```

<!-- Ce prochain chunk de code n'apparait pas mais est utilisé pour générer la figure' -->

```{r plotresult, echo = FALSE, keep.source = TRUE, fig = TRUE, fig.align='center', fig.cap="Résultats de l'ANOVA à deux critères présentés sur l'échelle logarithmique (a) et sur l'échelle originale de la variable réponse (b)."}

par(mfrow = c(1, 2))

############# LOG TRANSFORM 
## Sexe - moyenne des groupes
## valeurs pour lesquelles faire des prédictions
## On commence par créer un tableau dans lequel 
## chaque ligne correspond à une combinaison des facteurs A et B.
pred.set <- expand.grid(Sexe = c("m", "f"), 
                        Trait = c("sans_horm", "horm"))

## La fonction predict nous donne les valeurs prédites par l’ANOVA
sex.means <- predict(aov.log, newdata = pred.set, se.fit = TRUE)

## Ajout des prédictions dans le jeu de données
pred.set$fit <- sex.means$fit
pred.set$se.fit <- sex.means$se.fit

##IC à 95%
## On détermine l’intervalle de confiance pour 
## construire nos barres d’erreur
## Rappelons que l’intervalle de confiance est donné par : 
## (IC.inf, IC.sup) (voir leçon 2)
## IC.inf = x.bar + qt(p=0.025, df)*SE
## IC.sup = x.bar - qt(p=0.025, df)*SE

pred.set$low95 <- pred.set$fit + 
  qt(p = 0.025, df = aov.log$df.residual) * pred.set$se.fit

pred.set$upp95 <- pred.set$fit - 
  qt(p = 0.025, df = aov.log$df.residual) * pred.set$se.fit
pred.set

##créer le graphique
plot(y = 0, x = 0, 
     ylab = "Log de la concentration en calcium",
     xlab = "Traitement", 
     ylim = c(min(pred.set$low95), max(pred.set$upp95)), 
     cex.lab = 1,
     xlim = c(0, 3), 
     type = "n", 
     cex.axis = 1, 
     xaxt = "n", 
     main = "Moyennes ± IC 95 % (échelle log)", 
     cex.main = 1)

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2), 
     labels = c("sans horm", "horm"), 
     cex.axis = 0.95)

##ajout des points pour mâles
points(y = pred.set$fit[c(1,3)], 
       x = c(0.9, 1.9), 
       pch = 1, 
       cex = 1)

##ajout des points pour femelles
points(y = pred.set$fit[c(2,4)], 
       x = c(1.1, 2.1), 
       pch = 2, 
       cex = 1)

##barres d'erreurs pour mâles
arrows(x0 = c(0.9, 1.9), 
       y0 = pred.set$low95[c(1, 3)], 
       y1 = pred.set$upp95[c(1, 3)],
       x1 = c(0.9, 1.9), 
       angle = 90, 
       code = 3, 
       length = 0.05)

##barres d'erreurs pour femelles
arrows(x0 = c(1.1, 2.1), 
       y0 = pred.set$low95[c(2, 4)], 
       y1 = pred.set$upp95[c(2, 4)],
       x1 = c(1.1, 2.1), 
       angle = 90, 
       code = 3, 
       length = 0.05)

##ajouter légende
legend(x = "topleft", 
       legend = c("mâles", "femelles"), 
       pch = c(1, 2))

text(x = 2.8, y = 2.3, labels = "a", cex = 2)


############# ORIGINAL 
##convertir sur échelle originale
pred.set$orig.fit <- exp(pred.set$fit)
pred.set$orig.low95 <- exp(pred.set$low95)
pred.set$orig.upp95 <- exp(pred.set$upp95)

##créer graphique
plot(y = 0, x = 0, 
     ylab = "Concentration en calcium",
     xlab = "Traitement", 
     cex.lab = 1, 
     ylim = c(min(pred.set$orig.low95), max(pred.set$orig.upp95)), 
     xlim = c(0, 3), 
     type = "n", 
     cex.axis = 1, 
     xaxt = "n", 
     main = "Moyennes ± IC 95 % (échelle originale)", 
     cex.main = 1)

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2), 
     labels = c("sans horm", "horm"), 
     cex.axis = 0.95)

##ajout des points pour mâles
points(y = pred.set$orig.fit[c(1,3)], 
       x = c(0.9, 1.9), 
       pch = 1, 
       cex = 1)

##ajout des points pour femelles
points(y = pred.set$orig.fit[c(2,4)], 
       x = c(1.1, 2.1), 
       pch = 2, 
       cex = 1)

##barres d'erreurs pour mâles
arrows(x0 = c(0.9, 1.9), 
       y0 = pred.set$orig.low95[c(1, 3)], 
       y1 = pred.set$orig.upp95[c(1, 3)],
       x1 = c(0.9, 1.9), 
       angle = 90, 
       code = 3, 
       length = 0.05)

##barres d'erreurs pour femelles
arrows(x0 = c(1.1, 2.1), 
       y0 = pred.set$orig.low95[c(2, 4)], 
       y1 = pred.set$orig.upp95[c(2, 4)],
       x1 = c(1.1, 2.1), 
       angle = 90, 
       code = 3, 
       length = 0.05)

text(x = 2.8, y = 10, labels = "b", cex = 2)

##ajouter légende
legend(x = "topleft", 
       legend = c("mâles", "femelles"), 
       pch = c(1, 2), 
       cex = 1)
``` 

Le graphique sur l'échelle logarithmique (Figure \@ref(fig:plotresult)a) montre clairement que les effets sont additifs (pas d'effet d'interaction), puisque la distance entre le cercle et le triangle du traitement hormonal est la même que celle entre les deux symboles du traitement sans hormone. 

Il est aussi approprié de présenter les résultats sur l'échelle originale de la variable réponse en effectuant l'opération inverse du logarithme naturel (c.-à-d., `exp( )`) sur la moyenne et sur les bornes inférieures et supérieures des intervalles de confiance. 

```{r plotresult-exp, echo = TRUE, keep.source = TRUE, include = TRUE, fig = FALSE, eval=FALSE}
## On prend l’exponentiel pour convertir les données 
## transformées par le logarithme.
pred.set$orig.fit <- exp(pred.set$fit)
pred.set$orig.low95 <- exp(pred.set$low95)
pred.set$orig.upp95 <- exp(pred.set$upp95)

##créer graphique
plot(y = 0, x = 0, 
     ylab = "Concentration en calcium",
     xlab = "Traitement", 
     cex.lab = 2, 
     ylim = c(min(pred.set$orig.low95), max(pred.set$orig.upp95)), 
     xlim = c(0, 3), 
     type = "n", 
     cex.axis = 2, 
     xaxt = "n", 
     main = "Moyennes ± IC 95 % (échelle originale)", 
     cex.main = 2)

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2), 
     labels = c("sans horm", "horm"), 
     cex.axis = 2)

##ajout des points pour mâles
points(y = pred.set$orig.fit[c(1,3)], 
       x = c(0.9, 1.9), 
       pch = 1, 
       cex = 2)

##ajout des points pour femelles
points(y = pred.set$orig.fit[c(2,4)],
       x = c(1.1, 2.1), 
       pch = 2, 
       cex = 2)

##barres d'erreurs pour mâles
arrows(x0 = c(0.9, 1.9), 
       y0 = pred.set$orig.low95[c(1, 3)], 
       y1 = pred.set$orig.upp95[c(1, 3)],
       x1 = c(0.9, 1.9), 
       angle = 90, 
       code = 3, 
       length = 0.05)

##barres d'erreurs pour femelles
arrows(x0 = c(1.1, 2.1), 
       y0 = pred.set$orig.low95[c(2, 4)], 
       y1 = pred.set$orig.upp95[c(2, 4)],
       x1 = c(1.1, 2.1), 
       angle = 90, 
       code = 3, 
       length = 0.05)

text(x = 2.8, 
     y = 10, 
     labels = "b", 
     cex = 2)

##ajouter légende
legend(x = "topleft", 
       legend = c("mâles", "femelles"), 
       pch = c(1, 2), 
       cex = 2)
```

En l'absence d'une interaction statistiquement significative (comme dans cet exemple), on présente les résultats séparément pour chaque facteur (Figure \@ref(fig:resCalcium)). On voit à la Figure  \@ref(fig:resCalcium) que la concentration de calcium du groupe sans traitement hormonal est bien inférieure à celle du groupe avec traitement hormonal, alors que les différences entre mâles et femelles sont beaucoup moins marquées.

```{r resCalcium, echo = FALSE, keep.source = FALSE, include = TRUE, fig.align='center', fig.cap="Résultats présentés séparément pour chaque facteur de l'ANOVA à deux critères présentés sur l'échelle d'origine. Les groupes qui ont les mêmes lettres ne diffèrent pas entre eux pour un facteur donné et avec un seuil de d'effet significatif $\\alpha$ < 0.05."}
##moyenne des sexes
  sex.means <- tapply(X = (calcium$Concentration), INDEX = calcium$Sexe, FUN = mean)
  sex <- data.frame(sex.means, MSE = 22.898)
  sex$RMSE <- sqrt(sex$MSE)
  sex$low <- sex$sex.means - sex$RMSE
  sex$upp <- sex$sex.means + sex$RMSE
  
  #sex.means <- tapply(X = calcium$Concentration, INDEX = calcium$Sexe, FUN = mean)
  
  
  ##moyenne des traitements
  treat.means <- tapply(X = (calcium$Concentration), INDEX = calcium$Trait, FUN = mean)
  treat <- data.frame(treat.means, MSE = 22.898)
  treat$RMSE <- sqrt(treat$MSE)
  treat$low <- treat$treat.means - treat$RMSE
  treat$upp <- treat$treat.means + treat$RMSE
  
  #treat.means <- tapply(X = calcium$Concentration, INDEX = calcium$Trait, FUN = mean)
  
  par(mfrow = c(1, 2))
  
  ##créer graphique
  plot(y = 0, x = 0, 
       ylab = "Concentration en calcium",
       xlab = "Traitement", 
       ylim = c(2.3, max(treat$upp)), 
       xlim = c(0, 3), 
       type = "n", 
       cex.lab = 1.2, 
       xaxt = "n", 
       main = "Moyennes ± racine carrée de MSE")
  
  ##ajout de l'axe des x's
  axis(side = 1, 
       at = c(1, 2), 
       labels = c("horm", "sans horm"), 
       cex = 1.2)
  
  ##ajout des points
  points(y = treat$treat.means, 
         x = c(1, 2), 
         pch = 1)
  
  ##barres d'erreurs
  arrows(x0 = c(1, 2), 
         y0 = treat$low, 
         y1 = treat$upp,
         x1 = c(1, 2), 
         angle = 90, 
         code = 3, 
         length = 0.05)
  
  ##groups
  text(x = 1, y = 23, labels = "a", cex = 1.2)
  text(x = 2, y = 7, labels = "b", cex = 1.2)
  
  ##sexe
  plot(y = 0, x = 0, 
       ylab = "Concentration en calcium",
       xlab = "Sexe", 
       ylim = c(2.6, max(sex$upp)), 
       xlim = c(0, 3), 
       type = "n", 
       cex.lab = 1.2, 
       xaxt = "n", 
       main = "Moyennes ± racine carrée de MSE")
  
  ##ajout de l'axe des x's
  axis(side = 1, 
       at = c(1, 2), 
       labels = c("femelles", "mâles"), 
       cex = 1.2)
  
  ##ajout des points
  points(y = sex$sex.means, 
         x = c(1, 2), 
         pch = 1)
  ##barres d'erreurs
  arrows(x0 = c(1, 2), 
         y0 = sex$low, 
         y1 = sex$upp,
         x1 = c(1, 2), 
         angle = 90, 
         code = 3, 
         length = 0.05)
  
  ##groups
  text(x = 1, y = 17, labels = "a", cex = 1.2)
  text(x = 2, y = 13, labels = "a", cex = 1.2)


``` 
:::



### Effets additifs

Dans l'exemple précédent, on remarque que l'effet du premier facteur est indépendant de l'effet du deuxième facteur. En d'autres mots, la différence entre les mâles et les femelles est constante, peu importe le traitement hormonal. En l'absence d'une interaction statistiquement significative entre les deux facteurs, nous dirons que les effets des facteurs sont **additifs**. C'est ce qu'on entend par l'**additivité** des facteurs. En contrepartie, la présence d'une interaction significative entre les facteurs complique l'interprétation des résultats de l'expérimentation. Effectivement, la présence d'une interaction permet d'identifier des phénomènes souvent plus intéressants scientifiquement que s'il n'y avait pas d'interaction entre les facteurs. C'est ce que nous constaterons dans certains des exemples suivants.



:::{.exemple section=7}
 Nous désirons déterminer l'effet du type de moulée (avoine, blé ou orge) et du type de supplément alimentaire (*agrimore*, *control*, *supergain* et *supersupp*) sur le gain en masse en kg de bétail après 6 semaines. Les données sont stockées dans le fichier `croissance.csv`^[Le fichier `csv` est un type de fichier de texte standard où chaque élément est séparé le plus souvent par une virgule, un espace ou une point-virgule. Ce format s'importe dans R à l'aide de `read.table( )` puisque c'est un fichier de texte, en modifiant la valeur de l'argument `delim`.].

```{r echo = TRUE, keep.source = TRUE, tidy=TRUE}
##importation avec séparateur virgule car ici
##les champs sont séparés par des virgules
croissance <- read.table("Module_7/data/croissance.csv", header = TRUE, 
                         sep = ",")
head(croissance)

##la fonction str() affiche la structure interne du tableau
##C’est une fonction alternative à summary()
str(croissance)

##comparer avec importation sans sep = ","
crois2 <- read.table("Module_7/data/croissance.csv", header = TRUE)
head(crois2)
##on remarque un problème à l'importation
##les étiquettes des variables et les valeurs sont
##erronées
str(crois2)


##transformer en facteurs les variables en caracteres
croissance$Supplement<-as.factor(croissance$Supplement)
croissance$Diete<-as.factor(croissance$Diete)
```

On vérifie le nombre de répétitions pour chaque combinaison des deux facteurs :

```{r reps, echo = TRUE, keep.source = FALSE}
table(croissance$Supplement, croissance$Diete)
``` 

Nous disposons de quatre répétitions pour chaque combinaison de facteurs. Ainsi, nous pourrons inclure un terme d'interaction dans l'ANOVA à deux facteurs. Avant de lancer l'analyse, on peut jeter un coup d'oeil aux données brutes à l'aide d'un diagramme de boîtes et moustaches (Figure \@ref(fig:croisbox)).

```{r echo=TRUE, eval = FALSE, fig=FALSE}
##on crée un boxplot
boxplot(Gain ~ Supplement + Diete, data = croissance)
```

```{r croisbox, echo = FALSE, keep.source = FALSE, fig = TRUE, fig.align='center', fig.cap="Diagramme de boîtes et moustaches présentant les données de gain de masse en fonction du type de moulée (Diete) et de supplément (Supplement)."}
##on crée un boxplot
#boxplot(Gain ~ Supplement + Diete, data = croissance)

# Setting up the margins to make room for rotated labels
par(mar = c(6.2, 4, 4, 2) + 0.3)

# Creating the boxplot without x-axis labels
boxplot(Gain ~ Supplement + Diete, data = croissance, xaxt = 'n', xlab = "")

# Adding x-axis labels manually
labels <- unique(interaction(croissance$Supplement, croissance$Diete))
axis(side = 1, at = 1:length(labels), labels = FALSE)
text(x = 1:length(labels), y = par("usr")[3] - 0.5, labels = labels, srt = 45, adj = 1, xpd = TRUE)

# Adding the x-axis title separately
mtext(side = 1, line = 5.3, "Supplement and Diet")
```

Calculons maintenant l'ANOVA :

```{r aovcrois, echo = TRUE, keep.source = TRUE}
aov.crois <- aov(Gain ~ Supplement + Diete + Supplement:Diete,
                 data = croissance)
summary(aov.crois)
``` 

Avant d'interpréter les résultats, on vérifie les suppositions du modèle.

```{r croisdiag, echo = TRUE, include = TRUE, fig = TRUE, fig.align='center', fig.cap="Vérification des suppositions de l'ANOVA à deux critères."}
par(mfrow = c(1, 2))

##Vérification de la normalité des résidus
qqnorm(residuals(aov.crois), 
       ylab = "Quantiles observés",
       xlab = "Quantiles théoriques", 
       main = "Graphique quantile-quantile",
       cex.lab = 1.2)

qqline(residuals(aov.crois))

##Vérification de l'homogénéité de la variance
plot(residuals(aov.crois) ~ fitted(aov.crois), 
     ylab = "Résidus", 
     xlab = "Valeurs prédites", 
     main = expression(paste(bold(Résidus), " ", bold(italic(vs)), " ", 
         bold(valeurs), " ", bold(prédites))), 
     cex.lab = 1.2)
``` 

Nous remarquons que les résidus sur le graphique suivent généralement une distribution normale et qu'à l'exception de trois observations, l'homogénéité des variances est respectée (Figure \@ref(fig:croisdiag)). Nous pouvons donc procéder à l'interprétation des résultats. 

Le type de supplément et le type de moulée ont tous deux un effet important sur le gain de masse (supplément: $F_{3, 36} = 17.81, P < 0.0001$; type de moulée: $F_{2, 36} = 83.52, P < 0.0001$). Toutefois, il n'y aucune preuve d'une interaction entre les deux facteurs ($F_{6, 36} = 0.33, P = 0.92$). On peut donc conclure que les effets sont additifs. Les comparaisons multiples suggèrent des différences entre certains groupes de chaque facteur :

```{r multcompcrois, echo = TRUE, keep.source = TRUE}
##On test d’abord les interactions entre les suppléments
tapply(X = croissance$Gain, INDEX = croissance$Supplement, 
       FUN = mean)
##
##Tukey
mult.supp <- TukeyHSD(aov.crois, which = "Supplement")
mult.supp$Supplement

##On test les interactions entre les diètes
tapply(X = croissance$Gain, INDEX = croissance$Diete, 
       FUN = mean)
##Tukey
mult.diete <- TukeyHSD(aov.crois, which = "Diete")
mult.diete$Diete
```

On peut représenter les résultats des comparaisons multiples comme suit pour le type de supplément :  

```{r echo=FALSE}
diet.df <- data.frame(
  supergain = 19.714,
  control = 20.399,
  supersupp = 22.368,
  agrimore = 23.005
)

kable(diet.df, 
      row.names = FALSE, 
      "html", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = F, position = "center")
```

On peut représenter les résultats des comparaisons multiples comme suit pour le type de moulée (`Diete`)  :

```{r echo=FALSE}
diet.df2 <- data.frame(
  blé = 18.431,
  avoine = 21.329,
  orge = 24.422
)

kable(diet.df2, 
      row.names = FALSE, 
      "html", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = F, position = "center")
```

La figure \@ref(fig:figcrois) illustre les résultats.

```{r figcrois, echo = TRUE, keep.source = TRUE, include = TRUE, fig = TRUE, fig.align='center', fig.cap="Graphique des effets du type de supplément alimentaire (\texttt{Supplement}) et du type de moulée (\texttt{Diete}) sur le gain de masse en kilogrammes."}
par(mfrow = c(1, 2))
##supplement
supp.means <- tapply(X = croissance$Gain, 
                     INDEX = croissance$Supplement, FUN = mean)
supp <- data.frame(supp.means, MSE = 1.719)
supp$RMSE <- sqrt(supp$MSE)
supp$low <- supp$supp.means - supp$RMSE
supp$upp <- supp$supp.means + supp$RMSE

##diete
diet.means <- tapply(X = croissance$Gain, 
                     INDEX = croissance$Diet, FUN = mean)
diet <- data.frame(diet.means, MSE = 1.719)
diet$RMSE <- sqrt(diet$MSE)
diet$low <- diet$diet.means - diet$RMSE
diet$upp <- diet$diet.means + diet$RMSE

##créer graphique
plot(y = 0, x = 0, 
     ylab = "Gain de masse (kg)",
     xlab = "Supplément", 
     ylim = c(18, max(supp$upp)), 
     xlim = c(0, 5), 
     type = "n", 
     cex.lab = 1.2, 
     xaxt = "n", 
     main = "Moyennes ± racine carrée de MSE")

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2, 3, 4), 
     labels = c("agri", "cont", "sgain", "ssupp"), 
     cex.axis = 0.85)

##ajout des points pour l'ensemble des cereales
points(y = supp$supp.means, x = 1:4, pch = 1)

##barres d'erreurs
arrows(x0 = 1:4, 
       y0 = supp$low, 
       y1 = supp$upp,
       x1 = 1:4, 
       angle = 90, 
       code = 3, 
       length = 0.05)

##groups
text(x = 2, y = 18.93, labels = "a", cex = 1.2)
text(x = 3, y = 18.25, labels = "a", cex = 1.2)
text(x = 1, y = 21.61, labels = "b", cex = 1.2)
text(x = 4, y = 20.89, labels = "b", cex = 1.2)
     
##créer graphique
plot(y = 0, x = 0, 
     ylab = "Gain de masse (kg)",
     xlab = "Diète", 
     ylim = c(16, max(diet$upp)), 
     xlim = c(0, 4), 
     type = "n", 
     cex.lab = 1.2, 
     xaxt = "n", 
     main = "Moyennes ± racine carrée de MSE")

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2, 3), 
     labels = c("avoine", "blé", "orge"), 
     cex = 1.2)

##ajout des points pour blé
points(y = diet$diet.means, x = 1:3, pch = 1)

##barres d'erreurs
arrows(x0 = 1:3, 
       y0 = diet$low, 
       y1 = diet$upp,
       x1 = 1:3, 
       angle = 90, 
       code = 3, 
       length = 0.05)

##groups
text(x = 1, y = 19.7, labels = "a", cex = 1.2)
text(x = 2, y = 16.8, labels = "b", cex = 1.2)
text(x = 3, y = 22.8, labels = "c", cex = 1.2)
``` 
:::


<br>


:::{.exemple section=7}
Comme dernier exemple, nous analyserons l'effet de la concentration d'un antibiotique et de l'humidité sur la croissance d'une espèce de bactéries que l'on peut cultiver en laboratoire dans des plats de Pétri contenant un substrat de sucres appelé agar-agar. La variable réponse ici est la surface du substrat couverte par les colonies de bactérie mesurée en mm$^2$. Le fichier `antibio.txt` contient les données. 

```{r importantibio, echo=TRUE, keep.source=TRUE}
antibio <- read.table("Module_7/data/antibio.txt", header = TRUE)
head(antibio)
##on détermine le nombre de répétitions
table(antibio$Humidite, antibio$Concentration)
```

On présente les données par un diagramme de boîtes et moustaches (Figure \@ref(fig:boxantibio)).

```{r boxantibio, echo=TRUE, keep.source=TRUE, fig = TRUE, fig.align='center', fig.cap="Diagramme de boîtes et moustaches de la surface couverte en mm$^2$ en fonction de la concentration d'un antibiotique et de l'humidité."}
boxplot(Surface ~ Humidite + Concentration, data = antibio)
``` 

<!-- L'ordre des codes et textes dans dans le pdf c'est : le texte "On vérifie..." puis on a directement ensuite "On réalise...", puis le code de l'anova et puis la figure 10. Donc j'ai inversé les codes ici pour matcher avec le pdf car dans .rnw c'est text "On vérifie...", code anova, code graph, text "On réalise...", re-code anova -->

On vérifie ensuite les suppositions d’homogénéité des variances et de normalités des résidus. On remarque que celles sont respectées (fig. \@ref(fig:antibioDiag)).

On réalise maintenant l'ANOVA à deux critères :

```{r}
aov.antibio <- aov(Surface ~ Humidite + Concentration + 
                   Humidite:Concentration,
                   data = antibio)
summary(aov.antibio)
``` 

```{r antibioDiag, echo=FALSE, fig=TRUE, keep.source=FALSE, fig.align='center', fig.cap="Homogénéité des variances et normalité des résidus de l'ANOVA à deux critères réalisées sur les données d'activité bactérienne (surface couverte par les colonies de bactéries)."}
## CODE QUI N"APPARAIT PAS DANS LE PDF

par(mfrow = c(1, 2))
##vérification de l'homogénéité des variances
plot(residuals(aov.antibio) ~ fitted(aov.antibio),
     ylab = "Résidus", 
     xlab = "Valeurs prédites",
     main = expression(bold(Résidus), " ", bold(italic(vs)),
       bold(valeurs), " ", bold(prédites)))
##Vérification de la normalité des résidus
qqnorm(residuals(aov.antibio), 
       main = "Graphique quantile-quantile",
       ylab = "Quantiles observés", 
       xlab = "Quantiles théoriques")
qqline(residuals(aov.antibio))
``` 

Le tableau d'ANOVA montre une interaction importante entre les facteurs `Humidite` et `Concentration` ($F_{2, 24} = 163.4, P < 0.0001$). Les effets de la concentration d'antibiotique et de l'humidité ne sont pas additifs. Ceci implique que nous ne pouvons pas interpréter ces effets séparément, car l'effet d'un facteur dépend du niveau de l'autre facteur. Nous pouvons utiliser les comparaisons multiples pour trouver les différences entre les groupes définis par les différentes combinaisons des deux facteurs. 

```{r antibioTukey}
tapply(X = antibio$Surface, 
       INDEX = list(antibio$Humidite, antibio$Concentration), 
       FUN = mean)
mult.inter <- TukeyHSD(aov.antibio, which = "Humidite:Concentration")
mult.inter$'Humidite:Concentration'
``` 

Les comparaisons multiples suggèrent les groupes suivants :

```{r eval=FALSE, include=FALSE}
### LES LIGNES NE MARCHENT PAS ICI MAIS AVEC LE TABLEAU HTML
# Create the table data
data <- data.frame(
  "humide-élevée" = c("1.64 mm^2","",""),
  "sec-faible" = c("2.25 mm^2","",""),
  "sec-modérée" = c("2.29 mm^2","",""),
  "sec-élevée" = c("3.07 mm^2","",""),
  "humide-modérée" = c("5.04 mm^2","",""),
  "humide-faible" = c("5.87 mm^2","","")
)
# Insert underscores to simulate horizontal lines
data[2, 1:2] <- c('<span style="border-bottom: 1px solid;">_________</span>')
data[3, 2:3] <- c('<span style="border-bottom: 1px solid;">_________</span>')
data[2, 4:6] <- c('<span style="border-bottom: 1px solid;">_________</span>')

# Display the table
kable(data, format = "html", escape = FALSE, col.names = names(data)) %>%
  kable_styling("striped", full_width = FALSE)

```

<table>
  <tr>
    <th style="border: 0px solid black; padding: 3px;">humide-élevée</th>
    <th style="border: 0px solid black; padding: 3px;">sec-faible</th>
    <th style="border: 0px solid black; padding: 3px;">sec-modérée</th>
    <th style="border: 0px solid black; padding: 3px;">sec-élevée</th>
    <th style="border: 0px solid black; padding: 3px;">humide-modérée</th>
    <th style="border: 0px solid black; padding: 3px;">humide-faible</th>
  </tr>
  <tr>
    <td>1.64 mm<sup>2</sup></td>
    <td>2.25 mm<sup>2</sup></td>
    <td>2.29 mm<sup>2</sup></td>
    <td>3.07 mm<sup>2</sup></td>
    <td>5.04 mm<sup>2</td>
    <td>5.87 mm<sup>2</sup></td>
  </tr>
  <tr>
    <td colspan="2" style="border-bottom: 2px solid;">&nbsp;</td>
    <td></td>
    <td style="border-bottom: 2px solid;">&nbsp;</td>
    <td></td>
    <td style="border-bottom: 2px solid;">&nbsp;</td>
  </tr>
  <tr>
    <td></td>
    <td colspan="2" style="border-bottom: 2px solid;">&nbsp;</td>
    <td></td>
    <td style="border-bottom: 2px solid;">&nbsp;</td>
    <td></td>
  </tr>
</table>

Représentons maintenant les résultats graphiquement.

```{r antibioRes, echo=TRUE, keep.source=TRUE, fig.align='center', fig.cap="Interaction significative entre l'humidité et la concentration d'antibiotique sur l'activité bactérienne."}
##valeurs prédites
pred.out <- expand.grid(Humidite = c("sec", "humide"), 
              Concentration = c("faible", "moderee", "elevee"))

preds <- predict(aov.antibio, newdata = pred.out, se.fit = TRUE)

pred.out$mean <- preds$fit
pred.out$se <- preds$se.fit

##IC à 95%
pred.out$low95 <- pred.out$mean + 
  qt(p = 0.025, df = aov.antibio$df.residual) * pred.out$se
pred.out$upp95 <- pred.out$mean - 
  qt(p = 0.025, df = aov.antibio$df.residual) * pred.out$se

##graphique
plot(y = 0, x = 0, 
     ylab = "",
     xlab = "Concentration d'antibiotique", 
     ylim = c(1, max(pred.out$upp95)), 
     xlim = c(0, 4), 
     type = "n", 
     cex.lab = 1.2, 
     xaxt = "n", 
     main = "Moyennes ± IC à 95 %")

##ajout d'étiquette en marge
##expression permet d'ajouter des lettres grecques,
##indices ou exposants
mtext(text = expression(paste("Surface (", mm^2, ")")),
      side = 2, 
      line = 2, 
      cex = 1.2)

##ajout de l'axe des x's
axis(side = 1, 
     at = c(1, 2, 3), 
     labels = c("faible", "modérée", "élevée"), 
     cex = 1.2)

##points pour sec
points(y = pred.out$mean[c(1, 3, 5)], x = 1:3, pch = 1)

##barres d'erreurs
arrows(x0 = 1:3, 
       y0 = pred.out$low95[c(1, 3, 5)], 
       y1 = pred.out$upp95[c(1, 3, 5)],
       x1 = 1:3, 
       angle = 90, 
       code = 3, 
       length = 0.05)

##points pour humide
points(y = pred.out$mean[c(2, 4, 6)], x = 1:3, pch = 2)

##barres d'erreurs
arrows(x0 = 1:3, 
       y0 = pred.out$low95[c(2, 4, 6)], 
       y1 = pred.out$upp95[c(2, 4, 6)],
       x1 = 1:3, 
       angle = 90, 
       code = 3, 
       length = 0.05)

##légende
legend(x = "topright", 
       pch = c(1, 2), 
       legend = c("sec", "humide"),
       title = "Humidité")

##groupes
text(x = 1, y = 5.4, labels = "a", cex = 1.2)
text(x = 2, y = 4.6, labels = "b", cex = 1.2)
text(x = 3, y = 1.2, labels = "c", cex = 1.2)
text(x = 1, y = 1.82, labels = "cd", cex = 1.2)
text(x = 2, y = 1.87, labels = "d", cex = 1.2)
text(x = 3, y = 2.6, labels = "e", cex = 1.2)
``` 

La Figure \@ref(fig:antibioRes) montre qu'il y a bien une interaction entre les deux facteurs. Nous voyons clairement que la différence entre la moyenne du groupe "sec" et celle du groupe "humide" varie énormément avec la concentration d'antibiotique, et que cette différence est la plus faible quand la concentration d'antibiotique est élevée.

On remarque qu'il y a une inversion des différences entre les groupes "sec" et les groupes "humide" : la surface couverte moyenne du groupe "humide" est supérieure à celle du groupe "sec" aux concentrations faible et modérée d'antibitioque. Toutefois, le groupe "sec" a une plus grande surface couverte moyenne que le groupe "humide" à la concentration élevée d'antibiotique. On conclut que l'augmentation de la concentration de l'antibiotique réduit l'activité bactérienne sous des conditions humides, mais augmente l'activité bactérienne en conditions plus sèches. 
:::



### Conclusion 

Dans ce texte, vous vous êtes familiarisés avec l'ANOVA à deux critères avec plusieurs répétitions par groupe aux traitements combinés, et particulièrement avec les concepts d'interaction et d'additivité. Trois exemples ont été présentés afin d'illustrer les différentes étapes de l'analyse, de la vérification des suppositions, de l'interprétation et de la présentation graphique des résultats. Nous avons vu qu'en présence d'une interaction entre deux facteurs, on ne peut pas interpréter les effets principaux, car l'effet d'un facteur sur la variable réponse dépend du niveau de l'autre. On dit dans ce cas que les effets ne sont pas additifs. C'est justement ce qu'illustre le dernier exemple sur l'activité bactérienne: l'augmentation de la concentration d'antibiotique n'avait pas le même effet selon le niveau d'humidité du milieu. Le concept d'interaction est important et il est souvent associé à des hypothèses intéressantes en sciences. Nous vous encourageons à revoir les exemples afin de bien saisir la notion d'interaction, car nous l'étudierons à nouveau dans les leçons à venir.

## Laboratoire

### Question 1

On effectue une expérience pour déterminer si la longueur en cm chez une espèce de poisson varie selon le sexe ou le pH de l'eau. Importez le fichier `Longueur_poisson.xls` pour voir les données^[Si `MS Excel` n'est pas installé sur votre ordinateur, il est possible d'importer le fichier à l'aide des suites bureautiques libres `OpenOffice` [http://www.openoffice.org/fr/Produits/](http://www.openoffice.org/fr/Produits/) ou `LibreOffice` [http://fr.libreoffice.org/](http://fr.libreoffice.org/).].

**a.** Déterminez le nombre de répétitions (*replicates*) pour chaque combinaison des deux facteurs. Veuillez interpréter les résultats obtenus avec `RStudio` ou `R Commander`.  

 
**b.** Réalisez une ANOVA à deux critères (fournir le tableau de l’ANOVA) et effectuez tous les diagnostics permettant d'évaluer la pertinence de votre analyse. Que pouvez-vous conclure?  

  
**c.** Lorsqu'il est approprié de le faire, utilisez un test de Tukey (fournir l’*output*) afin d'identifier les différences entre les moyennes. Que pouvez-vous conclure?  

 
**d.** Illustrez vos conclusions de l'étude à l'aide d'un graphique.  

 
**e.** Les effets sont-ils additifs?  